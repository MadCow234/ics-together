<!DOCTYPE html>
<html>
  <head>
    <title>ICS Together</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        font: 13px Helvetica, Arial;
      }
      form {
        background: #000;
        padding: 3px;
        height: 41px;
        width: 100%;
      }
      form input {
        border: 0;
        padding: 10px;
      }
      form button {
        width: calc(10% - 8px);
        background: rgb(130, 224, 255);
        border: none;
        padding: 10px;
      }
      #upcoming-420 {
        font-size: 3vw;
      }
      #clock {
        font-size: 8vw;
      }
      #clock-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 50vh;
        width: 100vw;
      }
      .user-countdown {
        height: 100px;
        width: 100px;
        background-color: red;
        position: absolute;
      }
      .default-clock {
        color: black;
      }
      .two-minute-warning {
        color: yellow;
      }
      .thirty-second-alert {
        color: red;
      }
      .its-time-success {
        color: green;
      }
      #messages-container {
        height: 50vh;
        width: 100vw;
        padding-bottom: 10px;
        overflow-y: auto;
      }
      #messages {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      #messages li {
        padding: 5px 10px;
        word-wrap: break-word;
      }
      #messages li:nth-child(odd) {
        background: #eee;
      }
      #typing-status {
        height: 2em;
        width: 100%;
        padding: 4px 8px;
      }
      #username {
        width: 18em;
      }
      #message {
        width: calc(90% - 18em);
      }
      .no-select {
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* supported by Chrome and Opera */
      }
    </style>
  </head>
  <body>
    <div id="clock-container" class="no-select">
      <span id="upcoming-420"></span>
      <span id="clock"></span>
    </div>
    <div id="messages-container">
      <ul id="messages"></ul>
    </div>
    <div id="typing-status">
      <span id="typing-status-message"></span>
    </div>
    <form action="">
      <input id="username" autocomplete="off" placeholder="Username" />
      <input id="message" autocomplete="off" placeholder="Type a message..." />
      <button>Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function() {
        let socket = io();
        let typingList = new Array();
        let numCountdowns = 0;

        // The server will update the clock 10 times per second, but we don't want
        //   jQuery constantly updating the DOM, so always check to see if the
        //   client actually needs to be updated before invoking jQuery functions.
        socket.on("clock", clock => {
          let time = new Date(clock.time).toLocaleString("en-US", {
            hour: "numeric",
            minute: "numeric",
            second: "numeric",
            hour12: true
          });

          let upcoming420String = `Coming up: ${clock.upcoming420Timezone}`;

          if ($("#upcoming-420").html() !== upcoming420String) {
            $("#upcoming-420").html(upcoming420String);
          }

          // Update the clock time if it changes
          if ($("#clock").html() !== time) {
            $("#clock").html(time);
          }

          // Update the CSS class if it changes
          if (!$("#clock").hasClass(clock.cssClass)) {
            $("#clock").removeClass();
            $("#clock").addClass(clock.cssClass);
          }
        });

        $("#messages").append($("<li>").text("You are connected."));

        $("#clock-container").click(e => {
          // Require a shift-click to start a countdown
          if (e.shiftKey) {
            // Prevent starting a countdown overtop of an existing countdown
            if (e.target.id === "clock-container" || e.target.id === "clock") {
              if ($("#username").val() !== "") {
                let xPos = (e.clientX / $(document).width()) * 100;
                let yPos = (e.clientY / $(document).height()) * 100;
                let countdownData = {
                  username: $("#username").val(),
                  xPosition: xPos,
                  yPosition: yPos
                };
                socket.emit("initiate_countdown", countdownData);
              }
            }
          }
        });

        socket.on("run_countdown", countdown => {
          if (countdown.action === "remove") {
            $(`#${countdown.id}`).remove();
          } else if (countdown.action === "create") {
            $("#clock-container").append(countdown.container);
          } else if (countdown.action === "update") {
            if (!$(`#${countdown.id}`).length) {
              $("#clock-container").append(countdown.container);
            }
            $(`#${countdown.id}`).html(countdown.content);
          }
        });

        $("form").submit(e => {
          e.preventDefault();
          var messageData = {
            username: $("#username").val() || "(anonymous)",
            message: $("#message").val()
          };
          if (messageData.message !== "") {
            socket.emit("messages", messageData);
            $("#messages").append(
              $("<li>").text(messageData.username + ": " + messageData.message)
            );
            scrollToBottom();
            $("#message").val("");
          }
          socket.emit("stopped_typing", messageData.username);
          return false;
        });

        $("#message").on("input", () => {
          var username = $("#username").val() || "(anonymous)";
          if ($("#message").val() === "") {
            socket.emit("stopped_typing", username);
          } else {
            if (!typingList.includes(username)) {
              socket.emit("started_typing", username);
            }
          }

          var prevMessage = $("#message").val();
          setTimeout(() => {
            if (prevMessage === $("#message").val()) {
              socket.emit("stopped_typing", username);
            }
          }, 3000);
        });

        socket.on("messages", data => {
          $("#messages").append(
            $("<li>").text(data.username + ": " + data.message)
          );
          scrollToBottom();
        });

        socket.on("connections", msg => {
          $("#messages").append($("<li>").text(msg));
          scrollToBottom();
        });

        socket.on("typing_status", currentlyTypingList => {
          typingList = currentlyTypingList;
          $("#typing-status-message").remove();
          if (currentlyTypingList.length === 1) {
            $("#typing-status").append(
              '<div id="typing-status-message">' +
                currentlyTypingList +
                " is typing...</div>"
            );
          } else if (currentlyTypingList.length > 1) {
            $("#typing-status").append(
              '<div id="typing-status-message">' +
                currentlyTypingList.join(", ") +
                " are typing...</div>"
            );
          }
        });

        const scrollToBottom = () => {
          $("#messages-container").scrollTop($("#messages").height());
        };
      });
    </script>
  </body>
</html>
